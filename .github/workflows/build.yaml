on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      emsdk_version:
        description: 'Emscripten SDK version (e.g., 3.1.50)'
        required: true
        type: string
        default: '3.1.68'
      title:
        description: 'Release title (e.g., v0.7.3 (Emscripten 3.1.50))'
        required: true
        type: string
        default: 'testing'

name: Build HDF5 Wasm

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    container: ghcr.io/kanaverse/emcmake-docker/builder:2024-10-01
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Fetch release name
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Use workflow inputs for manual triggers
            echo "EMSDK_VERSION=${{ inputs.emsdk_version }}" >> $GITHUB_ENV
            echo "TITLE=${{ inputs.title }}" >> $GITHUB_ENV
            echo "Using workflow inputs: ${{ inputs.title }}"
          else
            # Parse from tag for release triggers
            release=${GITHUB_REF#refs/*/}
            echo "RELEASE=${release}" >> $GITHUB_ENV
            emsdk=$(echo ${release} | sed "s/^v[^_]*_//") 
            echo "EMSDK_VERSION=${emsdk}" >> $GITHUB_ENV
            prefix=$(echo ${release} | sed "s/_.*//") 
            title="${prefix} (Emscripten ${emsdk})"
            echo "TITLE=${title}" >> $GITHUB_ENV
            echo $title
          fi

      - name: Activate Emscripten version
        run: |
          cd /emsdk && git pull
          emsdk install ${{ env.EMSDK_VERSION }}
          emsdk activate ${{ env.EMSDK_VERSION }}

      - name: Build library packages
        run: make all

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build tools
        run: |
          make tools
          npm pack tools-package/

      - name: Prettify release body
        run: |
          echo "Built with:" > release.txt
          echo "- "$(cmake --version | head -1) >> release.txt
          echo "- "$(emcc -v 2>&1 | head -1) >> release.txt
          echo "" >> release.txt
          echo "File SHA256:" >> release.txt
          echo \`\`\` >> release.txt
          for x in $(ls *-Emscripten.tar.gz)
          do
              shasum -a 256 $x >> release.txt
          done
          for x in $(ls hdf5-wasm-tools-*.tgz)
          do
              shasum -a 256 $x >> release.txt
          done
          echo \`\`\` >> release.txt
          cat release.txt

      - name: Publish tarballs
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *-Emscripten.tar.gz
            hdf5-wasm-tools-*.tgz
          name: ${{ env.TITLE }}
          body_path: release.txt 
